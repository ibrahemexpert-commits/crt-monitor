name: CRT Monitor
on:
  schedule:
    - cron: '*/15 * * * *' 
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest
    steps:
      - name: Check Certificates
        run: |
          # 1. Setup Environment Variables
          echo "BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}" >> $GITHUB_ENV
          echo "CHAT_ID=${{ secrets.TELEGRAM_CHAT_ID }}" >> $GITHUB_ENV
          
          # 2. Install Helper Tool
          sudo apt-get update && sudo apt-get install -y jq curl

          # 3. Set Target (Change this to test)
          TARGET="github.com" 

          # 4. Check Target
          echo "Checking $TARGET..."
          
          # 5. Fetch Data (Use -L to follow redirects)
          DATA=$(curl -s -L "https://crt.sh/?q=${TARGET}&output=json")
          
          # 6. Check if we got data
          if [ -z "$DATA" ]; then
            echo "Error: No data received from crt.sh"
            exit 1
          fi

          # 7. Get the latest certificate name
          # We use 'select' to find the first valid entry and pull the 'name_value'
          CERT_NAME=$(echo "$DATA" | jq -r '.[0].name_value' | head -n 1)

          # 8. Send Notification
          if [ -n "$CERT_NAME" ]; then
             echo "Found: $CERT_NAME"
             curl -s -X POST "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" \
               -d "chat_id=$CHAT_ID" \
               -d "text=ðŸ”” Monitor Result:%0A%0ATarget: $TARGET%0ALatest Cert: $CERT_NAME"
          else
             echo "No certificate found."
          fi
